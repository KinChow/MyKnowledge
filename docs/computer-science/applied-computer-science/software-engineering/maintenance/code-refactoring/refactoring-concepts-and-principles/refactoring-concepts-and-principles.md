# 重构的概念与原则

## 什么是重构

### 业界对软件重构的定义

所谓重构是这样一个过程：在**不改变代码外在行为**的前提下，对代码做出修改，以**改进程序的内在结构**。

重构（名词）：对软件内部结构的一种调整，目的是在**不改变软件可观察行为**的前提下，**提高其可理解性，降低其修改成本**。

重构（动词）：使用一系列**重构手法**，在不改变软件可观察行为的前提下，调整其结构。



### 重构与可信

重构层级定义和要求

* L0：功能正确
  * 定量标准：外在功能表现与需求一致
  * 手段&工具：功能点验收、自动化测试
  * 典型特征：功能正确

* L1：无漏洞风险
  * 定量标准：已知漏洞补丁有效管理，已知告警清零，无安全红线
  * 手段&工具：门禁、静态检查、CodeDex、安全编码规范、CQI
  * 典型特征：代码满足CQI基本要求，满足安全编码要求，安全漏洞风险可控

* L2：代码整洁
  * 定量标准：简洁、自注释、易维护、易测试
  * 手段&工具：通用编码规范、CodeStyle、CMetrics
  * 典型特征：代码简洁易懂，满足通用编码规范

* L3：架构敏捷
  * 定量标准：高内聚低耦合、易拓展、可移植、算法精巧
  * 手段&工具：持续重构、架构可视化、SAL
  * 典型特征：软件架构满足高内聚低耦合，具有可拓展性和可维护性特点

* L4：持续演进
  * 典型特征：软甲架构随业务特征和技术进步的变化而持续演进，代码保持新陈代谢，持续具备先进竞争力



### 重构的分类

* 架构（框架）级重构
* 模块级重构
* 函数级重构



## 为什么要重构

### 存量产品的问题

* **难以添加新特性**：添加1行代码需要阅读理解相关的几千行代码
* **存量代码难以理解**：培训和维护都异常困难，新员工成长缓慢，某些代码完全依赖特定的老员工，人员依赖风险大
* **难以保证产品质量**：缺乏有效的自动化测试，添加或修改1行代码都必须手工执行所有的测试用例
* **接口混乱**：文档缺失、模块内外耦合严重，典型表现为头文件混乱
* **简单堆砌式实现（垂直烟囱式）**：各种全局性控制变量多，且不断的异常性增加
* **系统资源不足**：内存、CPU、Flash空间等不足的问题开始不断显现
* **员工工作疲惫**：相似的任务、重复的代码、不断增加的工作量，使得员工疲惫不堪



### 优点

* 改进软件设计
  * 如果没有重构，程序的内部设计（架构）会逐步腐败变质
* 使软件更易被理解
  * 让代码更好地表达自己
* 帮助找到bug
  * 对代码的理解，可以有助与找到bug
* 提高编程速度
  * 良好的设计易于拓展和理解，省去了大量的分析和调试时间
* 偿还技术债务
  * 去除重复代码
  * 简化代码逻辑
  * 理清代码结构
  * 明确代码意图
* 高效开发



## 什么时候重构

重构应该随时随地进行，不应该为了重构而重构。之所以重构，是因为重构可以帮助你把要做的事情做得更好。



### 三次法则

事不过三，三则重构

* 第一次做某件事时只管去做
* 第二次做类似的事情会产生反感，但是无论如何还是做了
* 第三次再做类似的事情，就应该重构



### 重构时机

* **添加功能时**：让未来增加新特性时更快捷、更流畅
* **修补错误时**：因为代码不够清晰而无法一目了然地发现问题
* **复审代码时**：经验传递，改善设计



### 什么时候不适合做重构

* 代码太混乱，设计完全错误，与其重构，还不如重写
* 明天就是deadline，永远不要做”最后一分钟的修改“
  * 推迟重构，但是不可忽略
* 重构工作量显著的影响估计，一个任务估计是3天，如果为了重构则需要更多时间
  * 推迟重构
  * 可以把这个重构作为一个新任务，或者安排在重构的迭代中完成
* 没有任何更好的思路时，不可重构



## 如何重构

添加新功能和重构，一次只做一件事

* 添加新功能时，不应该修改既有代码，只管添加新功能

* 重构时，不能添加功能，只管改进程序结构



### 经典重构工作流程

1. 测试保护
2. 识别坏味道
3. 采用手法
4. 小步前进



### 实际项目中重构工作流程

1. 深入业务
   * 挖掘问题
     * 与业务专家结对，深入业务问题和代码痛点，挖掘本质原因
   * 深入代码
     * 深入了解业务知识，走读代码，以及了解团队当前的软件工程能力和协作方式
2. 重构设计
   * 领域建模
     * 深度走读代码，针对软件要解决的业务问题，抽象其本质，做初始的领域建模设计
   * 重构规则
     * 识别代码现状和领域模型之间的差距，确定重构的范围和优先级
   * 兼容方案
     * 设计重构过程中的新旧代码兼容方案，制定重构迭代过程中的软件平滑演进策略
3. 重构实施
   * 工程基线
     * 明确重构基线分支和合入策略
     * 搭建开发者测试工程。编写基线测试用例
     * 优化代码构建和测试反馈速度，匹配高效重构的节奏
     * 引入现代化IDE和辅助工具，提升重构的效率和安全性
   * 代码重构
     * 以正交设计原则和组合式设计为指导进行代码重构，持续演进代码和领域模型
     * 安全小步的重构操作：等价操作，过程可逆，随时停止，断点续传
     * 分离变化、消除重复的手法
       * 数据变化：分离数据与逻辑；数据外置；优化数据格式；
       * 行为变化：依赖注入；工厂与动态注册发现；
       * 类型变化：模板技术；代码生成；
4. 持续演进
   * 模型演进
     * 随着对业务的深入理解，持续优化和演进领域模型，保持代码与模型长期一致
   * 人员赋能
     * 培养具备演进式设计、重构和领域建模设计能力的程序员



### 大型重构项目工作流程

1. 逆向过程
2. 架构设计/模块设计
3. 框架实现/编程框架
4. 框架验证
5. 应用重构
6. 新特性
