# 常用性能设计模式

## 性能设计的原则和模式

### 定义

* 什么是软件设计模式？
  * 软件设计模式是对给定环境中常见问题的通用、可重用的解决方案
* 什么是性能设计模式？
  * 性能设计模式是给定环境中性能问题的通用、可重用的解决方案
* 口语化的表达
  * 从长期经验中总结出来的解决某种性能问题的套路



### 性能模式的定义模板

如何定义一个性能模式？五元祖模板

* 名字：容易记忆的名字
* 问题：促使我们采用该模式的问题场景
* 方案：我们该怎么解决这类问题？
* 优点：采用这个模式之后得到什么好处？
* 约束：采用这个模式潜在的约束和限制



### 性能设计原则和模板

#### 性能设计原则

* 资源消耗最小化
  * 所有的资源消耗都是有代价了，应该在满足设计目标的基础上，尽可能减少无效，低价值的资源占用和消耗，病死的高价值的资源使用在高价值的任务上
* 资源利用最大化
  * 利用好所有资源，CPU、内存、存储、网络等，使其同时最大化使用，避免部分资源低效、空闲和等待
* 任务处理最优化
  * 通过各个任务的最优匹配，处理简洁高效，用最少的资源干更多的活
* 大型任务分布化
  * 通过时间空间的分散，将大任务化整为零，降低对单点资源的要求



#### 性能设计模式及分类

| 四大原则       | 十二大模式   | 细分模式                                                     |
| -------------- | ------------ | ------------------------------------------------------------ |
| 资源消耗最小化 | 去除冗余资源 | 技术选型降冗余、特性功能瘦身、规格降冗余、业务模型降冗余、部署降冗余 |
|                | 按需使用资源 | 负载删减、动态加载、存储分级、数据压缩、主动离线、断点续传   |
|                | 业务灵活编排 | 业务规格、规则、流程可编排                                   |
| 资源利用最大化 | 共享计算资源 | 计算、网络、存储资源可共享                                   |
|                | 软硬互助协同 | 稳定功能硬化、软件补硬件、硬件可编程、同构组合、异构资源协同 |
| 任务处理最优化 | 降低交互频次 | 会话门面、消息订阅、报文合并去重、内容访问合并去重           |
|                | 提升任务效率 | 重要优先、快速通道、批处理、预处理、延后处理、异步处理       |
|                | 减少任务切换 | 降低切换频次，减少切换开销                                   |
|                | 缩短任务路径 | 资源访问本地化、业务处理高内聚、数据交互简单化、传输路径扁平框 |
|                | 多和处理并行 | 单任务拆分并行、多任务并行、多任务单核并发、流水线并行设计、去锁设计、众核并行 |
| 大型任务分布化 | 跨层系统互助 | 高效接口、灵活时序、层间互助                                 |
|                | 分布软件协同 | 任务分布处理、数据分布存储、时间拉长处理、云端协同、负载均衡、过载控制 |





## 常用性能设计模式

### 快速通道

名字：快速通道

问题：少数的业务场景，消耗大部分的系统性能

方案：通过减少关键核心事物的处理量，简化处理过程，来改进响应时间

优点：减少了关键事物的响应时间

约束：需要准确判定关键路径，如果判断错误，可能会导致性能不降反升



### 批处理

名字：批处理

问题：被频繁的请求任务需要消耗可观的时间用以前期准备或后继处理或中间传输

方案：把一段时间内经常性的任务和数据积累在一起批量处理

优点：减少了单个请求的平均处理时间，提升了整体效率

约束：批处理会导致业务处理延时增加，对延时有严格要求的任务不适合使用该方法；批处理失败后的处理较为复杂



### 预处理

名字：预处理

问题：关键任务执行时需要消耗可观的时间，用以申请资源，业务编排等可提前准备的事物

方案：将一部分工作提前到关键任务执行前执行，减少对关键任务的影响

优点：减少了关键任务的执行时间

约束：预分配的资源要足够；预处理信息更新要及时；本质是空间换时间，要权衡好空间时间关系



### 延后处理

名字：延后处理

问题：延后关键任务执行时需要消耗可观的时间用于不重要或不立即使用的事物

方案：相对不重要或者不立即使用的信息延后处理，优先保证关键流程的处理

优点：减少了关键任务的执行时间

约束：延后处理增加系统的复杂性，需要权衡性能及可靠性



### 异步处理

名字：异步处理

问题：服务提供者耗时大，服务请求的需要等待较长的时间才能得到结果

方案：通过异步响应，减少了调用者无谓的等待时间

优点：服务调用者减少了等待时间，提升了总体效率

约束：实现流程变得更复杂



### 合并去重

名字：合并去重

问题：消息的频繁交互给系统带来沉重的负担

方案：通过合并消息交互，或消息处理后再发送，或编码压缩后发送

优点：降低负载，减少交互，提升性能

约束：消息合并后会导致通知时延增加；编码压缩会增加计算开销，需权衡增加的开销和减少的传输量



### 并行处理

名字：并行处理

问题：多核系统中某些核繁忙，但某些核处于空闲状态

方案：通过合理设计任务使其能够充分发挥多核并行的处理能力

优点：提升业务处理效率

约束：不是所有流程都能并行处理，并行处理的可能带来额外的系统开销及资源争用，需慎重权衡



### 去锁设计

名字：去锁设计

问题：业务流程中存在大量锁竞争或者锁的临界区较大，造成整体性能下降

方案：通过无锁化设计，或者锁优化设计，来提升多核加速比

优点：减少串行执行比例，提升多核处理整体性能

约束：锁类型选择要正确



### 减少任务切换

名字：减少任务切换

问题：任务频繁切换浪费了大量CPU资源

方案：降低切换频次，减少切换开销，从而节省CPU的资源

优点：把节省出来的CPU资源用来处理业务，提升业务性能

约束：绑核设计可能影响核资源共享



### 软硬件协同

名字：软硬件协同

问题：少数的固定功能业务场景消耗大部分的CPU性能

方案：根据硬件资源特点，通过灵活的软件架构，合理调度，充分发挥不同硬件的功能

优点：提升软件和硬件的综合效率

约束：软硬件协同会提升系统的复杂性



## 性能设计模式的学习方法

### 经典书籍的学习

* 软件性能工程
* 性能之巅



### 熟悉基本概念

理解性能设计模式的基本概念，基本原则以及常见的模式



### 学习经典案例

学习业界经典的性能优化案例，和性能模式相对照，更深刻理解性能模式，做到举一反三



### 理论结合实际

多实践，多思考，理论联合实际，做到知行合一