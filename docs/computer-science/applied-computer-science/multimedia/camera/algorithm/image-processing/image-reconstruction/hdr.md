# HDR

## HDR背景介绍

HDR全称为High Dynamic Range，意思就是高动态范围，这是一种影像技术。HDR的目的是将图像高光部分的细节保留，同时提高欠曝部分的信噪比，从人眼的角度来看是暗的和亮的部分都能看到更多细节。



动态范围是衡量sensor在一幅图像里能够同时体现高光和阴影部分内容的能力
$$
20log_{10}(\frac{i_{max}}{i_{min}})
$$
i_max和i_min分别表示图像中最亮和最暗部分的电流。



|            | DR        |
| ---------- | --------- |
| 人眼       | 100 dB    |
| 普通sensor | 60 dB     |
| 高端sensor | 78 dB左右 |
| 自然场景   | 200+ dB   |



步骤
1. 获得HDR影像
2. 以HDR方式处理
3. HDR方式存储
4. HDR方式显示



目前我们ISP所说的HDR主要是HDR成像获取，但是由于技术原因，目前显示器上很难将这种HDR图像显示出来，所以需要drc和tone mapping来进行动态范围压缩



一般认为HDR为60dB以上，实际图像对比度达到1000:1，10bit有效带宽出图



带来的问题

* sensor的成本增加
* 有效带宽增加对ISP后续处理带来困难
* 还是远远达不到自然场景下的动态范围（200dB）



## HDR 合成常见问题及解决方法

### 问题

* 鬼影

  *  现象：同一位置的不同曝光帧像素之间出现不一致的问题，导致融合图像运动物体有虚影

  *  原因：相机抖动造成被拍摄物体运动的局部运动


* 噪点
  * 低曝光的图像存在噪点，会影响HDR的合成




### 去鬼影方法

#### Rejection-based

排除不同曝光像素间的不一致性，选取相对一致的像素



优点

* 结果解释性和可控性强
* 实现复杂度低



缺点

* 只参考当前位置像素信息，无法准确还原高反差运动物体的照度



#### Alignment-based

图像对齐，消除抖动/运动



优点

* 理论上找到对应点即可完全还原场景照度，不损失动态范围
* 对于局部非刚性运动可精细化处理



缺点

* 很难做到完全对齐，并引起新的artifact
* 稠密运动场计算复杂度较大



#### Optimization-based

定义全局能量函数，使其最小化



优点

* 综合亮度/对齐/运动信息，端到端
* 解决融合问题
* 效果相对最好



缺点

* 迭代次数多，计算量大



## HDR 算法介绍

* 多帧曝光合成
*   BME HDR
*   SME HDR
*   Quadra HDR
*   Stagger HDR



### 多帧曝光合成

步骤

1. 提取灰度图像
2. 图像配准
3. 灰度融合
4. 图像色彩恢复



优缺点

*  优点：保持图像空间分辨率
*  缺点：降低成像的帧率，容易造成鬼影现象




### BME HDR

Binning Multiplexed Exposure HDR (BME-HDR)



优缺点

*  优点：不影响成像帧率
*  缺点：垂直空间分辨率减半，会有鬼影现象



交错长短曝光：

通过择优选择短曝光或长曝光来实现HDR



### SME HDR

Spatially Multiplexed Exposure HDR (SME-HDR)



优缺点

*  优点：全分辨率HDR输出
*  缺点：插值算法复杂



同行像素不同曝光：

通过 Sony 特殊算法实现HDR



### Quadra HDR

* 正常模式
    *  快门时间一致，四像素合一，提高暗场景成像能力和提高信噪比
*  HDR模式
    *  设置长中短三种曝光时间，合成一帧HDR图像



优缺点

* 优点：场景和相机的相对运动减弱，减轻鬼影现象
* 缺点：demosaic技术要求高，且损失空间分辨率




### Stagger HDR



### Google的HDR Plus



## Tone Mapping

### Global tone mapping

1. 将不同曝光比生成的融合图像（通常bit位宽较大）进行数据压缩
2. 通过全局亮度信息调整图像的整体对比度，特别是保留高光区域信息



### Local tone mapping

通过图像局部区域的亮度信息重新分布亮度，提高图像的局部对比度和细节部分