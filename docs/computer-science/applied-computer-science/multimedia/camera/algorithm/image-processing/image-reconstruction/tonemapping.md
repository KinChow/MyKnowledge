# 色调映射

## 背景

一幅图亮度值的最大值和最小值之比称为动态范围（Dynamic Range）



高动态范围图像（HDR）



色调映射定义
色调映射（Tone mapping）：
在有限动态范图媒介上近似显示高动态跑图图像的一项计算机图形学技术。



## 算法

### 全局色调映射算法（空域不变算法）

全局色调映射算法只考虑像素的亮度值，不考虑像素的具体位置，对所有像素使用一样的映射函数进行映射。

常用算法；

* 基于S方程的色调映射算法
* 基于平均对数压缩的色调映射算法
* 基于直方图均衡化的色调映射算法



优点

* 计算量简便
* 实现简单
* 效率高



缺点

* 图像在色度、明度及细节上有损失



#### 基于S方程的色调映射算法

原理

用S曲线变换来压缩输入，这种变化压缩了暗区域和亮区域的动态范围，保留中等亮度细节信息。



#### 基于平均对数压缩的色调映射算法



#### 基于直方图均衡化的色调映射算法

直方图均衡化：把原始图像的灰度直方图从比较集中的某个灰度区间变成在全部灰度范围内的均匀分布



处理过程

1. 计算亮度分量的累积直方图
2. 得到一个均衡函数
3. 修整均衡函数
4. 亮度映射



### 局部色调映射算法（空域相关算法）

针对图像不同区域进行不同的变换，在调整图像中某点的灰度值时，將该点的空间位置也考虑在内。

常用算法：

* 基于分层模型的色调映射算法
*   基于梯度域的色调映射算法
*   基于摄影法的色调映射算法



#### 基于分层模型的色调映射算法

原理

将图像分解为两层，产生一个由大尺度变化信息构成的基本层和一个反映可见性信息的细节层，然后对基本层进行压缩变换，对细节层的信息予以保留。



#### 基于梯度域的色调映射算法

原理

在亮度的梯度域上，对大的梯度进行衰减，而对小的梯度保留或适当增强，以此来达到压缩动态范園并保留细节的目的。



优点

* 图像效果更好



缺点

* 算法复杂
* 计算量大
* 效率低



#### 基于摄影法的色调映射算法

原理

一种分区块的色调映射，即将过亮的区块变暗并将过暗的区块变亮，思想源于摄影技术中的遮光-曝光概念，最终将现实世界的高动态范图亮度映射到输出设备的低动态范函。



## 问题

### 饱和度降低

基于S方程的色调映射算法导致饱和度降低

解决方法：基于分层模型的色调映射算法，将图像分为色彩和亮度两部分，色彩不变，而亮度进行色调映射



### 局部对比度的缺失

基于分层模型的色调映射算法导致局部对比度缺失

解决方法：基于双边滤波色调映射



### Halo（光晕现象）

基于双边滤波色调映射导致光晕现象

光晕现象：指图像的暗区域或高亮区域的交界处，产生颜色反差的一种现象。

解决方法：基于加权最小二乘滤波器的色调映射



## 参考

* Fast Bilateral Filtering for the Display of HDRI, Durad F,2002
*    Gradient domain HDR compression, Fattal R,2002
*    Photographic Tone Reproduction for Digital Image, Reinhard E,2002
*    Edge-preserving decompositions for multi-scale tone and detail manipulation, Farbman Z. 2008
*    Tone-mapping high dynamic range images by novel histogram adjustment, Duan J 2010
*    Objective quality assessment of tone-mapped images, Yeganeh H, 2013