# 黑电平与线性化

## 黑电平的定义

黑电平（Black Level / Optical Black）：黑电平是图像数据中黑色数据（0）对应图像传感器采集的电平值。

一般sensor上会预留了一些完全没有曝光的像素，在上下两端都有一些未曝光的像素行，通过读取这些像素值的大小，可以实时得到黑电平。





## 黑电平的成因

黑电平形成的原因有多种，主要的形成原因为如下两点：

* 固定偏移。CCD/CMOS传感器采集的信息经过一系列转换生成原始RAW格式数据，RAW数据每个像素点有对应颜色的灰度信息。以8bit数据为例，单个像素的有效值是0~255。实际AD芯片（模数转换芯片）的精度可能无法将电压值很小的一部分转换出来，因此sensor厂家一般会在AD的输入之前加上一个固定的偏移量，使输出的像素值在5（非固定）~255之间，目的是为了让暗部的细节完全保留，但同时也会损失一些亮部细节。对于图像来说，更倾向关注暗部区域，因为ISP后面会有很多增益模块（LSC、AWB、Gamma等），因此亮区的一点点损失是可以接受的。
* 暗电流。sensor的电路本身会存在暗电流，导致在没有光线照射的时候，采集像素点也会有一定的输出电压。暗电流跟曝光时间和gain都有关系，不同的位置也是不一样的。因此在gain增大的时候，电路的增益增大，暗电流也会增强，因此很多ISP会选择在不同gain下减去不同的bl的值。



不同的温度，对OB的影响：

随着环境温度的变高，其OB的偏移也在加大，在去除OB的时候要考虑温度的影响，这个时候就要考研各家sensor的设计，工艺，算法上能力的时候了；同样道理，不考虑温度，其波动很大，RGB分布不均，也会导致偏色；



## 黑电平的消除

BLC各个通道均需要校正，目前比较常用的方法有：

* 中值
* 全局均值（几乎各家常用做法）
* 局部均值
* 自定义



### 使用场景

1. 校正前需要根据图像的具体情况进行分析，若图像平面趋于平整，则推荐使用全局均值
2. 若图像出现一些峰值，有明显的突出山峰，则推荐使用中值
3. 着图像出现某个角的值比校高，可能由于电源或者其他原因引起的，则推荐使用局部计算的方法



### 全局均值

在sensor上会预留了一些完全没有曝光的像素，在上下两端都有一些未曝光的像素行，通过读取这些像素值的大小，可以实时得到黑电平。sensor厂家称之为optical black level。



针对黑电平形成的原因，sensor采集的RAW数据在ISP处理时需要减去黑电平才是真正的RAW数据。
$$
Raw = SensorOutput - OpticalBlackLevel + pedestal
$$

* Black level correction基本上都在ISP来做，去掉那个pedestal基底即可

* optical black level


  * 固定数值，对RGB各通道可以是一样，也可以是不一样。


  * 固定数值，可以根据增益不同选择不同的数值。


* 利用黑电平随温度和gain的漂移曲线，利用一次函数的方式进行校正，但是对于不同sensor，漂移曲线不一样，因此该方案没有作为通用方案



### 双线性插值计算BLC减去的数值

将图像进行分块，根据块内四个顶点的黑电平偏移值，计算块网格给点像素位置的黑电平偏移值



### 高通平台

在高通的ISP pipeline，可以在两个地方去除black level值：

* black level correction
  * 整体清晰度好，因为raw域降噪程度少
* ABF后的BLS部分
  * 者整体噪声更好，因为满足raw域降噪算法，降噪更多；

当前在高通平台上的解决思路是，在ABF中，我们前期在black level中少去扣除一点基底，留一些给ABF，因为会根据不同的噪声分布，做双边滤波器，可以优化这种暗区RGB分布不均的情况，进而减少偏色现象，其后再在BLS模块中把剩下的基底再扣除掉





## 黑电平的影响

随着AG的增加，尤其是高倍gain，对于整幅画面中没有明显的亮区暗区变化的，其分布还是比较集中的，但是针对一副画面中既有亮区，又有暗区部分的时候，OB的平均值可能没变，但是其波动肯定会变大，尤其是暗区，是因为AG的增加，导致噪声的影响变大，所以OB的波动变大，这个时候sensor内部就不可能会增加OB均值去扣除，但是目前来看，各家sensor在扣除OB上，应该是均值扣除法，会导致暗部区域有偏色现象，而且是偏紫的，原因是因为OB的波动（方差）加大，如果再按照OB的均值扣除，那么就可能会有较多的残余，且RGB分量明显不平衡，后又受白平衡（Rgain、Bgain）的影响，故画面暗处会偏紫。



sensor输出raw数据中附加的黑电平值，需要在ISP最前端去干净。如果不去干净，干扰信息会影响后端ISP各模块的处理，尤其会导致AWB容易不准，画面整体出现偏绿或者偏红现象。

* 若ISP多扣一点OB，一是会导致AWB在暗区偏绿，二是会导致噪声形态被破坏；
* 若ISP分通道扣除OB，会导致不同的色温下，偏色情况不同；


黑电平校正失效在彩色图像的影响

* 当black level扣除过少时，整体图像画面灰蒙蒙的，对比度没有那么高
* 当black level扣除过多时，整体画面暗沉，细节损失多，黑色部分偏色，无法通过白平衡校正



黑电平校正失效在黑白图像中的影响

* 当black level扣除过少时，整体图像画面灰蒙蒙的，对比度没有那么高
* 当black level扣除过多时，整体画面暗沉，动态范围变低，纽节损失多，黑色部分偏色，无法通过白平衡校正





## 线性化背景

目前sensor输出的图像大部分都是非线性的，但是后端很多算法模块的处理是使用乘法（如镜头暗角矫正、色彩校正等），所以在ISP通路的开端就需要将非线性转换为线性。



## 线性化定义

对传感器的非线性校正，数学模型中sensor输出值和光强在整个有效范围内呈线性正比关系，但是物理上只有中间区域是线性的



## 线性化方法

在原像素上加减值，每个颜色通道都有一个校正曲线，其中Gr和Gb使用一个校正曲线
$$
P_{out}(x, y) = P_{in}(x, y) + F(x,y)
$$


#### 步骤

*  线性化校正曲线主要是把有效像素范围分为多个 regions
*   每个region划分不同的sections，最暗区和最亮区sensor随光强变化曲线变化最大，划分的section最多
*   根据输入像素值判断当前像素在第几个region， 在当前region的第几个section
*   通过查表得到当前section的左右端点对应的校正值
*  使用双线性插值根据当前section端点的校正值，计算出当前像素的校正值
*   将计算得到的校正值作用到输入像素值上，得到输出像素



## 参考

https://zhuanlan.zhihu.com/p/194206599

https://blog.csdn.net/xiaoyouck/article/details/72824534

https://deepinout.com/qcom-camera-tuning/qcom-camera-tuning-black-level-analysis.html