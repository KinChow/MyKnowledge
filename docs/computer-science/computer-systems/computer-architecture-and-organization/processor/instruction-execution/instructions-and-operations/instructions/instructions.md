# 指令

## 机器码

### 编译->汇编->机器码



### 指令格式和指令跳转



### 函数调用和程序栈



## 程序执行

### 静态链接和ELF格式

ELF（Executable and Linkable Format）是一种广泛使用的文件格式，它用于表示可执行文件、目标文件和共享库等二进制文件。ELF格式是由UNIX系统实验室（USL）开发的，并且已经成为Linux和许多其他类Unix操作系统的标准二进制文件格式。ELF格式的设计旨在提供高效的链接和加载过程，同时支持多种硬件架构和操作系统。



#### ELF文件的组成部分

ELF文件由以下几个主要部分组成：

1. **ELF头部（ELF Header）**：
   - 描述了文件的基本属性，如文件类型、目标架构、版本信息、入口点地址等。
   - 包含指向节区头表（Section Header Table）和程序头表（Program Header Table）的偏移量。

2. **节区头表（Section Header Table）**：
   - 包含了文件中所有节区（Section）的详细信息，如节区名称、类型、大小、偏移量等。
   - 节区是ELF文件中的一个逻辑单元，例如代码、数据、符号表等。

3. **程序头表（Program Header Table）**：
   - 仅在可执行文件和共享对象文件中存在，描述了文件在内存中的布局，包括各个段（Segment）的大小、位置和访问权限。

4. **节区（Sections）**：
   - 节区是ELF文件中的实际数据，每个节区包含特定类型的信息，例如：
     - `.text`：存储程序的可执行代码。
     - `.data`：存储初始化的全局变量和静态变量。
     - `.bss`：存储未初始化的全局变量和静态变量。
     - `.symtab`：存储符号表，包含了程序中所有符号（如函数和变量）的名称和地址。
     - `.strtab`：存储字符串表，包含了符号表中符号的名称。
     - `.rela.text`：包含了重定位信息，用于修正代码中的地址引用。

5. **段（Segments）**：
   - 段是程序加载到内存中的实体，通常一个段对应一个或多个节区。例如，代码段、数据段等。



#### ELF文件类型

ELF文件有几种不同的类型，主要包括：

- **可重定位文件（Relocatable File）**：
  - 这是编译器生成的中间文件，通常以`.o`为扩展名。它们尚未链接，可以被链接器用来创建可执行文件或静态库。

- **可执行文件（Executable File）**：
  - 这是最终的可执行程序，用户可以直接运行。在Linux下，通常位于`/bin`目录下，以无扩展名或`.exe`为扩展名存在。

- **共享对象文件（Shared Object File）**：
  - 这是动态链接库文件，可以在程序运行时被加载。在Linux下，以`.so`为扩展名。

- **核心转储文件（Core Dump File）**：
  - 当程序崩溃时，系统可能会生成一个核心转储文件，它包含了程序终止时的内存映像。



#### ELF文件的字节序

ELF文件可以是大端（Big-Endian）或小端（Little-Endian）格式。字节序是指多字节数据在内存中的存储顺序。ELF头部中的`e_ident`字段包含了字节序信息。



#### ELF文件的查看和分析

可以使用多种工具来查看和分析ELF文件，例如：

- `readelf`：显示ELF文件的头部、节区头表、符号表等信息。
- `objdump`：显示二进制文件的信息，包括汇编代码、节区内容等。
- `nm`：列出对象文件中的符号。



#### 总结

ELF格式为Linux和类Unix系统提供了一个灵活、高效的二进制文件格式，它支持复杂的链接和加载需求，并且可以适应不同的硬件架构。了解ELF格式的结构和组成部分对于系统程序员、编译器开发者和那些需要深入理解程序二进制接口的人来说是非常重要的。



### 程序装载和执行

#### 程序装载（Loading）

程序装载是将程序的可执行文件从磁盘读入内存，并为它分配内存空间的过程。这个过程通常由操作系统的装载器（Loader）完成，并且包括以下几个步骤：

1. **准备执行环境**： 操作系统为程序创建一个进程，并为该进程分配必要的资源，如文件描述符、内存空间等。
2. **读取可执行文件**： 装载器从磁盘读取可执行文件，这通常是一个ELF格式的文件，包含了程序的代码、数据、符号表等信息。
3. **解析文件头部**： 装载器解析ELF文件头部，获取程序的入口点地址、节区头表的位置等信息。
4. **建立地址空间**： 根据ELF文件中的节区信息，装载器在进程的虚拟地址空间中为程序的各个段（如代码段、数据段）分配内存，并建立段表。
5. **加载节区内容**： 装载器将ELF文件中的节区内容复制到进程的地址空间中。这包括将`.text`节区的代码加载到代码段，将`.data`节区的初始化数据加载到数据段等。
6. **重定位**： 如果程序包含可重定位的地址（即程序中引用了其他模块或库的地址），装载器需要根据当前进程的地址空间进行地址修正。
7. **解析动态链接**： 对于动态链接的程序，装载器需要解析程序依赖的共享库，并在运行时将它们加载到进程的地址空间中。



#### 程序执行（Execution）

程序执行是程序开始运行的过程。一旦程序被装载到内存中，操作系统的调度器会根据调度策略选择该进程执行，并将其状态设置为运行状态。执行过程包括以下几个方面：

1. **处理器状态切换**： 操作系统将处理器的控制权交给程序，并设置处理器的状态以执行用户代码。
2. **执行入口点**： 程序从ELF文件头部指定的入口点地址开始执行。这通常是程序的`main`函数或其他启动例程。
3. **执行指令**： 处理器按照程序的指令集执行程序代码。程序可以进行输入输出操作、调用系统服务、创建线程等。
4. **系统调用**： 当程序需要操作系统提供的服务时（如文件操作、网络通信、内存分配等），它会进行系统调用。操作系统会处理这些请求，并返回结果给程序。
5. **上下文切换**： 操作系统负责管理多个进程的执行。当一个进程的时间片用完或发生阻塞等待（如等待I/O操作完成）时，操作系统会进行上下文切换，将当前进程的状态保存，并切换到另一个进程执行。
6. **程序结束**： 当程序执行完毕或被操作系统终止时，操作系统会清理进程使用的资源，并从进程表中移除该进程的条目。



#### 总结

程序的装载和执行是操作系统中确保程序能够顺利运行的关键环节。装载过程负责将程序从磁盘加载到内存中，并建立执行所需的环境。执行过程则是程序代码实际运行的阶段，操作系统在这个过程中提供必要的支持和服务。了解这些基本概念对于理解程序如何在操作系统中运行至关重要。



### 动态链接